# 其他决策

---

### 决策1 用集群满足高可用

约束

* C1: 数据存储出现故障要能继续工作
* C2: 数据存储出现故障的频率要小于1次/周
* C3: 数据故障恢复时间要小于12小时

候选方案

1. 采用数据库集群存储评论等数据
2. 采用搜索引擎集群存储商品信息数据
3. 基于冷备的故障切换

选择方案

* 1
* 2

理由

* 集群技术可以直接使用现有软件
* 冷备的资源使用率低

影响

* 逻辑视图中,添加搜索引擎集群component
* 逻辑视图中,添加数据库集群component
* 开发视图中,将数据库集群和搜索引擎集群分为更细的包
* 部署视图中,节点部署在不同机器上
* 进程视图中,节点属于不同进程

新增的约束

* AC1:  数据库集群和搜索引擎集群具有一致性更新功能
* AC2:  数据库集群和搜索引擎集群具有故障切换功能

### 决策2 多实例满足高可用

约束

* C4: 服务器出现故障不影响网站访问

候选方案

* 运行多个应用实例

选择方案

* 1

理由

* 实现简单,可以使用现成的负载均衡软件

影响

* 逻辑视图中,通过distributed RPC访问服务
* 开发视图中,增加LoadBalancer包
* 进程视图中,有多个服务进程
* 部署视图中,服务被部署在不同机器上

新增的约束

* 应用服务器要使用distributed RPC访问

### 决策3 用心跳算法检测故障

约束

* C5: 服务器出现故障能在1小时内发现

候选方案

1. 使用Ping/Echo方法检测服务器故障

2. 心跳算法

选择方案

* 2

理由

* 可以使用现成软件实现

影响

* 增加新的component,Register
* 增加新的connector,Heartbeat
* 进程视图中增加新的Register进程
* 部署视图中,Register部署在独立的机器上

### 决策4 策略模式兼容不同网站

约束

* C6: 至少能兼容两种电商网站
* C7: 能兼容Amazon等英文网站

候选方案

1. 抽象商品信息接口

选择方案

* 1

理由

* 不同网站商品信息内容基本相同,可以比较容易地抽象出接口.

影响

* 增加新的component,OnlineGoodsService,即不同电商网搜索服务的抽象接口
* 开发视图增加OnlineGoodsService包

### 决策5 配置分词器兼容同义词

约束

* C13: 能兼容出现频率前100的关键字的同义词

候选方案

1. 配置分词器的同义词表

2. 建立同义词表,分别查询各个同义词

3. 直接使用其他电商网的搜索接口

选择方案

* 1

理由

* 配置分词器的同义词表实现简单
* 方案2效率低,实现困难
* 方案3效率低,也有被其他网站屏蔽的风险

影响

* 开发视图中,增加一个synonymsConfig,即近义词配置

新增的约束

* 使用的分词器允许配置同义词

### 决策6 增加filter实现竞价排名

约束

* C14: 允许通过竞价排名调整搜索排序

候选方案

1. 在处理搜索结果的pipe中添加竞价排名的filter,用来调整结果顺序
2. 编写专门的sort模块来处理排名

选择方案

* 1

理由

* 方案1与现有的pipe-filter架构集成更方便

影响

* 逻辑视图中增加sortFilter
* 开发视图中增加sortFilter

### 决策7 增加filter实现屏蔽商品

约束

* C15: 允许屏蔽特定商品
* C16: 允许运行时添加屏蔽商品

候选方案

1. 在搜索结果的pipe中添加屏蔽商品的filter
2. 删除搜索引擎中的相关商品

选择方案

* 1

理由

* 方案1与pipe-filter集成更方便
* 方案2效率低,实现复杂

影响

* 逻辑视图中增加shieldFilter
* 开发视图中增加shieldFilter

### 决策8 提高存取效率

约束

* C18: 对频繁访问的商品,读取速度&lt;0.01秒
* C19: 搜索的响应时间&lt;1s

候选方案

1. 缓存服务.将高频关键字的搜索结果缓存下来,将高频商品信息缓存下来.

2. 搜索引擎集群.增加数据冗余来加快搜索速度.

选择方案

* 1和2

理由

* 因为有个别商品被高频访问,因此缓存其信息和关键字能较大提升效率
* 对于非高频访问的商品,可以靠数据冗余提升读取速度
* 缓存可以使用现成软件
* 集群自带数据冗余功能

影响

* 逻辑视图中增加cacheService
* 开发视图中增加cacheService,cacheDB
* 进程视图中cacheDB是单独的进程

### 决策9 解决高并发

约束

* C20: 高峰时间允许500万用户同时使用

候选方案

1. 购买CND服务
2. 缓存服务
3. 多实例应用,运行多个应用服务器
4. 搜索引擎集群
5. 数据库集群

选择方案

* 以上全部

理由

* 考虑到大部分用户只访问首页和推荐页等静态页,因此用CDN可以分摊许多流量,并加快响应速度
* 其余方案已经在其他决策中采用

影响

* 之前已经画了,这里不影响视图

### 决策10 使用安全软件

约束

* C21: 若用户一分钟内访问频度超过200次,视为攻击并屏蔽 阻碍R10
* C22: 添加新的入侵检测规则能在1人/月内完成
* C23: 系统可以屏蔽特定IP的访问
* C24: 允许运行时添加屏蔽IP

候选方案

1. 使用服务器安全软件
2. 在Gateway中实现上述功能
3. 借助云平台的服务

选择方案

* 1

理由

* 服务器安全软件可以完成以上功能
* 项目时间紧迫,没时间自己开发
* 借助云平台服务需要额外开销,并和云平台耦合

影响

* 之前已经画了,这里不影响视图

### 决策11 增加敏感词filter

约束

* C25: 系统可以检测评论中的敏感词汇,通知管理员审核.
* C26: 可以运行时修改敏感词汇表

候选方案

1. 在评论的pipe中添加敏感词filter

2. 实现一个通知管理员的通知策略

选择方案

* 1和2

理由

* 与评论的pipe-filter集成方便

影响

* 逻辑视图增加sensitiveFilter
* 开发视图中增加sensitiveFilter

### 决策12 用AOP记录程序调用

约束

* C31: 系统可以通过配置进入测试环境
* C32: 系统在测试环境下,能够将程序调用路径,时间,输入,输出记入日志

候选方案

1. 使用允许通过配置切换环境的框架

2. 使用允许AOP的框架

3. 使用动态代理

4. 使用代码生成

选择方案

* 1和2

理由

* 3和4的实现过于复杂

影响

* 逻辑视图的connector:LoggerPC增加新的属性,可以切换环境,可以log

* 开发视图增加TestModeAspect

新增的约束

* 使用的框架允许通过配置切换环境
* 使用的框架允许AOP

### 决策13 构建异常-错误码对应表

约束

* C33: 系统能提供有规律的抱错码以供识别异常

候选方案

1. 构建一颗异常树,树中的异常有自己的编号
2. 建立一张异常-错误码表,可以相互转换

选择方案

* 2

理由

* 构建异常树工作量太大, 而且将错误码分散在个各类中,不好管理
* 转换表有利于配置化 

影响

* 开发视图增加新的ErrorCode包



